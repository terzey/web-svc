{{ define "dashboard.json" }}
{{ $Name := printf "%s-%s" .Release.Name .Chart.Name }}
{
  "__inputs": [],
  "__requires": [],
  "annotations": {
    "list": []
  },
  "editable": true,
  "gnetId": null,
  "graphTooltip": 0,
  "hideControls": false,
  "id": null,
  "links": [],
  "panels": [{
    "columns": [],
    "datasource": {
      "type": "Prometheus",
      "uid": "{{ .Values.mon.grafana.datasourceUid }}"
    },
    "gridPos": {
      "h": 4,
      "w": 24,
      "x": 0,
      "y": 0
    },
    "id": 2,
    "links": [],
    "styles": [],
    "targets": [{
      "datasource": {
        "type": "Prometheus",
        "uid": "{{ .Values.mon.grafana.datasourceUid }}"
      },
      "expr": "web_svc_build{job=\"{{ $Name }}\"}",
      "format": "table",
      "intervalFactor": 2,
      "legendFormat": "",
      "refId": "A"
    }],
    "timeFrom": null,
    "timeShift": null,
    "title": "Build",
    "transformations": [{
        "id": "filterFieldsByName",
        "options": {
          "include": {
            "names": [
              "branch",
              "chartVersion",
              "commit",
              "job",
              "version"
            ]
          }
        }
      },
      {
        "id": "groupBy",
        "options": {
          "fields": {
            "branch": {
              "aggregations": [
                "uniqueValues"
              ],
              "operation": "aggregate"
            },
            "chartVersion": {
              "aggregations": [
                "uniqueValues"
              ],
              "operation": "aggregate"
            },
            "commit": {
              "aggregations": [
                "uniqueValues"
              ],
              "operation": "aggregate"
            },
            "job": {
              "aggregations": [],
              "operation": "groupby"
            },
            "version": {
              "aggregations": [
                "uniqueValues"
              ],
              "operation": "aggregate"
            }
          }
        }
      },
      {
        "id": "filterFieldsByName",
        "options": {
          "include": {
            "names": [
              "branch (uniqueValues)",
              "chartVersion (uniqueValues)",
              "commit (uniqueValues)",
              "version (uniqueValues)"
            ]
          }
        }
      },
      {
        "id": "organize",
        "options": {
          "indexByName": {
            "branch (uniqueValues)": 2,
            "chartVersion (uniqueValues)": 0,
            "commit (uniqueValues)": 3,
            "version (uniqueValues)": 1
          },
          "renameByName": {
            "branch (uniqueValues)": "branch",
            "chartVersion (uniqueValues)": "chartVersion",
            "commit (uniqueValues)": "commit",
            "version (uniqueValues)": "version"
          }
        }
      }
    ],
    "type": "table"
  }],
  "refresh": "",
  "rows": [],
  "schemaVersion": 14,
  "style": "dark",
  "tags": [
    "{{ .Chart.Name }}",
    "{{ $Name }}"
  ],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-6h",
    "to": "now"
  },
  "timepicker": {
    "refresh_intervals": [
      "5s",
      "10s",
      "30s",
      "1m",
      "5m",
      "15m",
      "30m",
      "1h",
      "2h",
      "1d"
    ],
    "time_options": [
      "5m",
      "15m",
      "1h",
      "6h",
      "12h",
      "24h",
      "2d",
      "7d",
      "30d"
    ]
  },
  "timezone": "browser",
  "title": "{{ $Name }}",
  "version": 0
}
{{ end }}